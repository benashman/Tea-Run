/**
 * Module dependencies.
 */var http=require("http"),path=require("path"),connect=require("connect"),utils=connect.utils,sign=require("cookie-signature").sign,normalizeType=require("./utils").normalizeType,normalizeTypes=require("./utils").normalizeTypes,etag=require("./utils").etag,statusCodes=http.STATUS_CODES,cookie=require("cookie"),send=require("send"),mime=connect.mime,basename=path.basename,extname=path.extname,join=path.join,res=module.exports={__proto__:http.ServerResponse.prototype};res.status=function(e){this.statusCode=e;return this};res.links=function(e){return this.set("Link",Object.keys(e).map(function(t){return"<"+e[t]+'>; rel="'+t+'"'}).join(", "))};res.send=function(e){var t=this.req,n="HEAD"==t.method,r;if(2==arguments.length)if("number"!=typeof e&&"number"==typeof arguments[1])this.statusCode=arguments[1];else{this.statusCode=e;e=arguments[1]}switch(typeof e){case"number":this.get("Content-Type")||this.type("txt");this.statusCode=e;e=http.STATUS_CODES[e];break;case"string":if(!this.get("Content-Type")){this.charset=this.charset||"utf-8";this.type("html")}break;case"boolean":case"object":if(null==e)e="";else{if(!Buffer.isBuffer(e))return this.json(e);this.get("Content-Type")||this.type("bin")}}undefined!==e&&!this.get("Content-Length")&&this.set("Content-Length",r=Buffer.isBuffer(e)?e.length:Buffer.byteLength(e));r>1024&&(this.get("ETag")||this.set("ETag",etag(e)));t.fresh&&(this.statusCode=304);if(204==this.statusCode||304==this.statusCode){this.removeHeader("Content-Type");this.removeHeader("Content-Length");this.removeHeader("Transfer-Encoding");e=""}this.end(n?null:e);return this};res.json=function(e){if(2==arguments.length)if("number"==typeof arguments[1])this.statusCode=arguments[1];else{this.statusCode=e;e=arguments[1]}var t=this.app,n=t.get("json replacer"),r=t.get("json spaces"),i=JSON.stringify(e,n,r);this.charset=this.charset||"utf-8";this.get("Content-Type")||this.set("Content-Type","application/json");return this.send(i)};res.jsonp=function(e){if(2==arguments.length)if("number"==typeof arguments[1])this.statusCode=arguments[1];else{this.statusCode=e;e=arguments[1]}var t=this.app,n=t.get("json replacer"),r=t.get("json spaces"),i=JSON.stringify(e,n,r).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"),s=this.req.query[t.get("jsonp callback name")];this.charset=this.charset||"utf-8";this.set("Content-Type","application/json");if(s){this.set("Content-Type","text/javascript");var o=s.replace(/[^\[\]\w$.]/g,"");i=o+" && "+o+"("+i+");"}return this.send(i)};res.sendfile=function(e,t,n){function u(e){if(o)return;o=!0;f();r.headerSent||r.removeHeader("Content-Disposition");if(n)return n(e);if(r.headerSent)return;s(e)}function a(){if(o)return;f();n&&r.on("finish",n)}function f(){i.socket.removeListener("error",u)}var r=this,i=r.req,s=this.req.next,t=t||{},o;if("function"==typeof t){n=t;t={}}i.socket.on("error",u);var l=send(i,e);t.root&&l.root(t.root);l.maxage(t.maxAge||0);l.on("error",u);l.on("directory",s);l.on("stream",a);l.pipe(this);this.on("finish",f)};res.download=function(e,t,n){if("function"==typeof t){n=t;t=null}t=t||e;this.set("Content-Disposition",'attachment; filename="'+basename(t)+'"');return this.sendfile(e,n)};res.contentType=res.type=function(e){return this.set("Content-Type",~e.indexOf("/")?e:mime.lookup(e))};res.format=function(e){var t=this.req,n=t.next,r=e.default;r&&delete e.default;var i=Object.keys(e),s=t.accepts(i);this.set("Vary","Accept");if(s){this.set("Content-Type",normalizeType(s));e[s](t,this,n)}else if(r)r();else{var o=new Error("Not Acceptable");o.status=406;o.types=normalizeTypes(i);n(o)}return this};res.attachment=function(e){e&&this.type(extname(e));this.set("Content-Disposition",e?'attachment; filename="'+basename(e)+'"':"attachment");return this};res.set=res.header=function(e,t){if(2==arguments.length)this.setHeader(e,""+t);else for(var n in e)this.setHeader(n,""+e[n]);return this};res.get=function(e){return this.getHeader(e)};res.clearCookie=function(e,t){var n={expires:new Date(1),path:"/"};return this.cookie(e,"",t?utils.merge(n,t):n)};res.cookie=function(e,t,n){n=utils.merge({},n);var r=this.req.secret,i=n.signed;if(i&&!r)throw new Error('connect.cookieParser("secret") required for signed cookies');"object"==typeof t&&(t="j:"+JSON.stringify(t));i&&(t="s:"+sign(t,r));if("maxAge"in n){n.expires=new Date(Date.now()+n.maxAge);n.maxAge/=1e3}null==n.path&&(n.path="/");this.set("Set-Cookie",cookie.serialize(e,String(t),n));return this};res.redirect=function(e){var t=this.app,n=this.req,r="HEAD"==n.method,i=302,s;if(2==arguments.length)if("number"==typeof e){i=e;e=arguments[1]}else i=arguments[1];var o={back:n.get("Referrer")||"/"};e=o[e]||e;if(!~e.indexOf("://")&&0!=e.indexOf("//")){var u=t.path();"."==e[0]?e=n.path+"/"+e:"/"!=e[0]&&(e=u+"/"+e)}this.format({text:function(){s=statusCodes[i]+". Redirecting to "+encodeURI(e)},html:function(){var t=utils.escape(e);s="<p>"+statusCodes[i]+'. Redirecting to <a href="'+t+'">'+t+"</a></p>"},"default":function(){s=""}});this.statusCode=i;this.set("Location",e);this.set("Content-Length",Buffer.byteLength(s));this.end(r?null:s)};res.render=function(e,t,n){var r=this,t=t||{},i=this.req,s=i.app;"function"==typeof t&&(n=t,t={});t._locals=r.locals;n=n||function(e,t){if(e)return i.next(e);r.send(t)};s.render(e,t,n)};